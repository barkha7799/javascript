$(document).ready(function() {
  "use strict";

  function downloadModalHandler(event) {
    event.stopImmediatePropagation();
    event.preventDefault();

    // DOM
    var $link = $(event.target);
    var $metaCsrfToken = $('meta[name="csrf-token"]');
    var $modal = $("#modal-download");
    var $modalContent = $modal.find(".content");

    // Data
    var csrfToken = $metaCsrfToken.attr("content");
    var downloadable = $link.data("downloadable");
    var downloadFormatsUrl = $link.data("download-formats-url");
    var unlockDownloadUrl = $link.attr("href");

    // Views
    function showLoading() {
      $modalContent.html(
        '<p class="text-center" style="margin-bottom:0">Loading ...</p>'
      );
    }

    function showError() {
      $modalContent.html("Error! Please try again.");
    }

    function showInformation(data) {
      if (data.formats) {
        return showOptions(data);
      }

      var messages = [];

      if (data.paused) {
        messages.push(
          'Your membership is currently on pause. You need to resume in order to download "' +
            data.resource_title +
            '".'
        );
      } else {
        if (data.credit_balance == 0) {
          // -------------------- NO CREDITS START -------------------- //
          // no credits
          if (data.trialling && data.trial_plan_credits == 0) {
            messages.push("Your trial does not include downloads.");
          } else if (data.membership_plan_credits == 0) {
            messages.push("Your plan does not include downloads.");
          } else if (data.credit_limit) {
            messages.push(
              "Oh no! You already used your " +
                data.credit_limit +
                " downloads this month."
            );
          } else {
            messages.push("Oh no! You’re out of download credits.");
          }

          // credit renewal
          if (data.renewal_date && !data.trialling) {
            messages.push(
              "You’ll receive " +
                data.membership_plan_credits +
                " new download credits on " +
                data.renewal_date +
                "."
            );
          }
          // -------------------- NO CREDITS END-------------------- //
        } else {
          // -------------------- SOME CREDITS START -------------------- //
          // trial limit
          if (data.trialling) {
            messages.push(
              "You’re currently on a trial which limits you to " +
                data.trial_plan_credits +
                " free download(s)."
            );
          }

          // unlock cost
          if (data.credit_balance == 1) {
            messages.push("This will use your download credit.");
          } else {
            messages.push("This will use 1 of your download credits.");
          }

          // unlock action
          messages.push(
            '<a href="' +
              data.links.unlock.href +
              '" class="button" data-unlock-action>Confirm Download</a>'
          );

          // current balance
          if (data.credit_limit) {
            messages.push(
              "You get up to " +
                data.credit_limit +
                " downloads every month. You have " +
                data.credit_balance +
                " left."
            );
          } else {
            messages.push(
              "You have " + data.credit_balance + " download credits."
            );
          }
          // -------------------- SOME CREDITS END -------------------- //
        }

        // -------------------- POSSIBLY CREDITS START -------------------- //
        // trial conversion
        if (data.trialling) {
          if (data.credit_limit) {
            messages.push(
              "Your trial will convert to a paid plan on " +
                data.renewal_date +
                ", and will include up to " +
                data.credit_limit +
                " downloads each month."
            );
          } else if (data.membership_plan_unlimited) {
            messages.push(
              "Your trial will convert to a paid plan on " +
                data.renewal_date +
                ", and will include unlimited downloads each month."
            );
          } else {
            messages.push(
              "Your trial will convert to a paid plan on " +
                data.renewal_date +
                ", and will include " +
                data.membership_plan_credits +
                " downloads each month."
            );
          }
        }
      }

      if (data.links.resume) {
        messages.push(
          '<a href="' + data.links.resume.href + '">Resume now</a>'
        );
      } else if (data.links.upgrade) {
        messages.push(
          '<a href="' +
            data.links.upgrade.href +
            '">Upgrade for unlimited downloads</a>'
        );
      }
      // -------------------- POSSIBLY CREDITS END -------------------- //

      // render messages
      var html = "";
      $.each(messages, function(index, message) {
        html += "<p>" + message + "</p>";
      });
      $modalContent.html(html);
    }

    function showOptions(data) {
      var html = "<h2>Download " + data.title + "</h2>";
      if (data.instructions) {
        html += "<p>" + data.instructions + "</p>";
      }

      $.each(data.formats, function(index, format) {
        let downloadURL = format.url;
        if (format.name !== "Online") {

          const downloadParam = `{
            component: 'Download Book Modal',
            page: 'Product Page',
            productName: \`${data.title}\`,
            productType: 'Book',
            type: '${format.name}',
            url: '${window.location.href}',
          }`;

          html += `<div class="row collapse"><div class="columns large-5"><a href="${
            downloadURL  
          }" class="button ${
            format.available_offline ? "start" : ""
          } download-get" target="_blank" onclick="window
              .AmplitudeLogger()
              .logger('Download Book Modal - CTA Clicked', ${downloadParam})">${
            format.name
          }</a></div><div class="columns large-10"><p class="media-description">${
            format.description
          }</p></div></div>`;
        }
      });

      $modalContent.html(html);
    }

    // Actions
    function getNewDownloadUnlock(url) {
      showLoading();
      $.ajax({
        type: "GET",
        url: url,
      })
        .done(showInformation)
        .fail(showError);
    }

    function postUnlockDownload(url) {
      showLoading();
      $.ajax({
        type: "POST",
        url: url,
        headers: { "X-Transaction": "POST", "X-CSRF-Token": csrfToken },
      })
        .done(function(data) {
          $link.data("downloadable", "true");
          showOptions(data);
        })
        .fail(showError);
    }

    function getDownloadFormats(url) {
      showLoading();
      $.ajax({
        type: "GET",
        url: url,
      })
        .done(showOptions)
        .fail(showError);
    }

    // Event listeners
    $modal.one("opened", function(event) {
      if (downloadable) {
        getDownloadFormats(downloadFormatsUrl);
      } else {
        getNewDownloadUnlock(unlockDownloadUrl);
      }
    });

    $modal.one("click", "a[data-unlock-action]", function(event) {
      event.stopImmediatePropagation();
      event.preventDefault();
      postUnlockDownload($(event.target).attr("href"));
    });

    // Open modal
    $modal.foundation("reveal", "open");
  }

  if (window.location.toString().indexOf("dashboard") !== -1 || (window.SP && window.SP.application === "reeedr"))
    $("body").on("click", ".js-modal-download-trigger", downloadModalHandler);
    $("a.js-modal-download-trigger").on("click", downloadModalHandler);
    $(".js-modal-download-triggers").on("click", "a.js-trigger-item", downloadModalHandler);
  
});
